# План Разработки Веб-Агента (Архитектура "Мастер-Воркер")

## Этап 1: Создание Ядра — Умного Воркера (Сессионный Агент)

*Цель: Создать один автономный модуль, способный выполнить задачу в одном браузере.*

-   [x] **1.1. Настройка проекта и базовые зависимости**
-   [ ] **1.2. Ядро Воркера и подключение к браузеру**
    -   [x] Создать класс `SessionAgent` (Воркер).
    -   [x] Реализовать подключение к запущенному браузеру по CDP через `playwright`.
-   [ ] **1.3. Модуль Восприятия (Perception)**
    -   [x] Реализовать получение URL, HTML.
    -   [x] Реализовать получение Дерева Доступности (A11y Tree).
    -   [ ] Написать обертку для API `OmniParser` (Vision).
    -   [ ] Создать гибридный метод `perceive()`, который комбинирует разные источники данных.
-   [ ] **1.4. Модуль Принятия Решений (Decision)**
    -   [x] Создать заглушку для вызова LLM.
    -   [ ] Реализовать функцию для формирования промпта для `Gemma-3`.
    -   [ ] Реализовать логику, требующую от LLM **строго структурированный JSON** и его валидацию.
-   [ ] **1.5. Модуль Действий (Human-like Action)**
    -   [x] Создать заглушки для "человекоподобных" действий.
    -   [ ] **Человекоподобный клик:** Реализовать функцию `human_like_click` с плавным движением мыши.
    -   [ ] **Человекоподобный ввод:** Реализовать функцию `human_like_type` с посимвольным вводом.
    -   [ ] **Человекоподобный скролл:** Реализовать функцию `human_like_scroll`.

## Этап 2: Построение Распределенной Системы Оркестрации

*Цель: Связать компоненты в единую систему, способную управлять множеством воркеров.*

-   [ ] **2.1. Центральное Хранилище Состояния**
    -   [ ] Выбрать и интегрировать решение (например, Redis) для хранения состояния задач, планов и прогресса.
    -   [ ] Переделать API Оркестратора для работы с этим хранилищем.
-   [ ] **2.2. Очередь Задач (Task Queue)**
    -   [ ] Выбрать и интегрировать брокер сообщений (например, RabbitMQ/Celery).
    -   [ ] Модифицировать Оркестратор, чтобы он ставил `task_id` в очередь.
    -   [ ] Превратить `SessionAgent` в воркера, который слушает очередь.
-   [ ] **2.3. Мастер (Оркестратор)**
    -   [x] Реализовать базовое API для приема задач.
    -   [ ] Интегрировать `Gemma-3` для декомпозиции цели в план.
    -   [ ] Реализовать механизм запуска/остановки Воркеров в отдельных процессах.

## Этап 3: Продвинутые Возможности и Обучение

*Цель: Повысить интеллект, эффективность и автономность системы.*

-   [ ] **3.1. Система Памяти для Успешных Сценариев (RAG)**
    -   [ ] Выбрать и настроить векторную базу данных (например, `ChromaDB`).
    -   [ ] Реализовать сохранение "успешных сценариев" в базу.
    -   [ ] Модифицировать Модуль Решений Воркера, чтобы он обогащал промпт релевантными примерами.
-   [ ] **3.2. Система Обучения на Ошибках (Failure Learning)**
    -   [ ] Создать **Базу Знаний Ошибок** в векторной БД.
    -   [ ] Реализовать сохранение пар "контекст ошибки -> успешная стратегия решения".
    -   [ ] Интегрировать поиск по Базе Знаний Ошибок в цикл восстановления агента.

## Этап 4: Отказоустойчивость и "Неуязвимость"

*Цель: Сделать систему надежной и стремящейся к 100% выполнению задач.*

-   [ ] **4.1. Детекция Аномалий (Сразу после действия)**
    -   [ ] Реализовать мониторинг HTTP-статусов (4xx, 5xx) и ошибок консоли браузера.
    -   [ ] Добавить "санитарные" проверки на всплывающие окна, cookie-баннеры, капчи и т.д.
-   [ ] **4.2. Интеллектуальное Восстановление (Если аномалия найдена)**
    -   [ ] **LLM-классификатор ошибок:** Создать функцию, которая по контексту аномалии определяет ее тип (`invalid_credentials`, `captcha_detected`).
    -   [ ] **Многоуровневые стратегии отката:**
        -   [ ] Реализовать "микро-откат" (повтор действия).
        -   [ ] Реализовать "шаг-откат" (возврат на предыдущий шаг плана).
        -   [ ] Реализовать "сессионный откат" (обновление страницы).
    -   [ ] **Адаптивное повторение:** Научить LLM предлагать измененные параметры для действия при повторной попытке.
-   [ ] **4.3. Human-in-the-Loop (HIL)**
    -   [ ] Реализовать механизм пометки задачи как "требующей вмешательства".
    -   [ ] Создать API для получения оператором контекста ошибки и "проталкивания" агента.
    -   [ ] Решение оператора должно автоматически сохраняться в Базу Знаний Ошибок.
-   [ ] **4.4. Аудит и Мониторинг**
    -   [ ] Настроить централизованное логирование с привязкой к `task_id` и `worker_id`.
    -   [ ] Внедрить метрики успешности, % HIL, и частоты ошибок для анализа. 