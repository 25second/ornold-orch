# Web Agent Framework

Это продвинутый фреймворк для создания веб-агентов, способных выполнять сложные задачи в браузере. Архитектура построена по принципу "Мастер-Воркер" для обеспечения масштабируемости и отказоустойчивости.

## Архитектура

- **Оркестратор (Мастер)**: FastAPI-приложение, которое принимает задачи, декомпозирует их на планы с помощью LLM и ставит в очередь.
- **Воркеры (Сессионные Агенты)**: Celery-воркеры, которые берут задачи из очереди. Каждый воркер управляет одним экземпляром браузера через Playwright (CDP), выполняет шаги плана, принимает решения на основе LLM и взаимодействует с системой памяти.
- **Очередь Задач**: Redis используется как брокер для Celery, обеспечивая асинхронное выполнение задач.
- **Центральное Хранилище Состояния**: Redis используется для хранения состояния всех задач в реальном времени.
- **Система Памяти (RAG)**: ChromaDB используется для создания двух баз знаний: одна для успешных сценариев, другая — для логов ошибок и их решений.
- **Мозг (LLM)**: Внешний API (например, Gemma на RunPod) используется для планирования, принятия решений и классификации ошибок.
- **Эмбеддинги**: Внешний API (например, Infinity Embedding на RunPod) для векторизации текста для системы RAG.

## Настройка

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка файла `.env`

Создайте файл `.env` в корневой директории проекта и заполните его следующими переменными:

```ini
# Ключ доступа к API сервиса RunPod
RUNPOD_API_KEY="ВАШ_API_КЛЮЧ_RUNPOD"

# ID эндпоинта для модели Gemma
RUNPOD_ENDPOINT_ID_GEMMA="ID_ЭНДПОИНТА_GEMMA"

# ID эндпоинта для модели эмбеддингов
RUNPOD_ENDPOINT_ID_EMBEDDING="ID_ЭНДПОИНТА_EMBEDDING"

# (Опционально) Название модели эмбеддингов, если отличается от дефолтной
# EMBEDDING_MODEL_NAME="BAAI/bge-small-en-v1.5"
```

## Запуск

Для работы системы необходимо запустить три компонента в трех разных терминалах: **Redis**, **Celery Worker** и **FastAPI Orchestrator**. Также необходим запущенный браузер в режиме удаленной отладки.

### 1. Запуск браузера (Chrome) с CDP

Запустите ваш антидетект-браузер или обычный Chrome с флагом удаленной отладки на нужном порту (в коде по умолчанию используется `9222`).

Пример для Windows:
```bash
"C:\Program Files\Google\Chrome\Application\chrome.exe" --remote-debugging-port=9222
```

### 2. Запуск Redis

Убедитесь, что у вас установлен и запущен Redis. Если вы используете Docker, это самая простая команда:
```bash
docker run -d -p 6379:6379 redis
```

### 3. Запуск Celery Worker

Откройте новый терминал в корне проекта и выполните команду:

```bash
celery -A worker worker --loglevel=info -P solo
```
* `-P solo` используется для Windows, чтобы избежать проблем с форками. Для Linux/macOS можно убрать.

### 4. Запуск Оркестратора (FastAPI)

Откройте третий терминал и запустите веб-сервер:

```bash
uvicorn orchestrator.main:app --reload
```

После этого Оркестратор будет доступен по адресу `http://127.0.0.1:8000`.

## Использование

### Создание новой задачи

```bash
curl -X POST "http://127.0.0.1:8000/tasks" ^
-H "Content-Type: application/json" ^
-d '{
  "goal": "Зайти на сайт github.com и найти в поиске репозиторий \"langchain\"",
  "browser_profiles": ["profile1"]
}'
```

### Проверка статуса задачи

GET `http://127.0.0.1:8000/tasks/{task_id}`

### Возобновление задачи (Human-in-the-Loop)

POST `http://127.0.0.1:8000/tasks/{task_id}/resume`
```json
{
  "action": {
    "action": "click", 
    "element_id": "#css-selector-от-человека"
  }
}
``` 